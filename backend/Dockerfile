# ============================================================
# ğŸ  ë¶€ë™ì‚° ë¶„ì„ í”Œë«í¼ - Dockerfile
# ============================================================
# ë¹Œë“œ: docker build -t realestate-api .
# ì‹¤í–‰: docker run -p 8000:8000 realestate-api
# ============================================================

# Python 3.11 ìŠ¬ë¦¼ ì´ë¯¸ì§€ ì‚¬ìš©
FROM python:3.11-slim

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
# - gcc: ì¼ë¶€ Python íŒ¨í‚¤ì§€ ì»´íŒŒì¼ì— í•„ìš”
# - libpq-dev: PostgreSQL í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
# - libgeos-dev: Shapely/GeoAlchemy2ì— í•„ìš”
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    libgeos-dev \
    && rm -rf /var/lib/apt/lists/*

# requirements.txt ë¨¼ì € ë³µì‚¬ (ìºì‹± ìµœì í™”)
# .dockerignoreê°€ ì ìš©ë˜ì–´ ë¶ˆí•„ìš”í•œ íŒŒì¼ì€ ì œì™¸ë¨
COPY requirements.txt .

# Python ì˜ì¡´ì„± ì„¤ì¹˜
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
# .dockerignoreê°€ ì ìš©ë˜ì–´ ë¶ˆí•„ìš”í•œ íŒŒì¼ì€ ì œì™¸ë¨
COPY ./app ./app

# ë¹„root ì‚¬ìš©ìë¡œ ì‹¤í–‰ (ë³´ì•ˆ)
RUN adduser --disabled-password --gecos "" appuser && \
    chown -R appuser:appuser /app
USER appuser

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import httpx; httpx.get('http://localhost:8000/health')" || exit 1

# ì„œë²„ ì‹¤í–‰
# --host 0.0.0.0: ì™¸ë¶€ ì ‘ì† í—ˆìš©
# --port 8000: í¬íŠ¸ ì§€ì •
# --workers 4: ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìˆ˜ (CPU ì½”ì–´ì— ë§ê²Œ ì¡°ì •)
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]

# ê°œë°œìš© (hot reload)
# CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
